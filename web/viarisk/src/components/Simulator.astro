---
import SimuladorField from "./SimuladorField.astro";
import SimuladorResult from "./SimuladorResult.astro";

// 1. PROVINCIAS (Convertidas a objetos para el Select)
const provincias = [
  "ALAVA", "ALBACETE", "ALICANTE", "ALMERIA", "AVILA", "BADAJOZ", "BALEARES", 
  "BARCELONA", "BURGOS", "CACERES", "CADIZ", "CASTELLON", "CIUDAD REAL", 
  "CORDOBA", "A CORU√ëA", "CUENCA", "GIRONA", "GRANADA", "GUADALAJARA", 
  "GUIPUZCOA", "HUELVA", "HUESCA", "JAEN", "LEON", "LLEIDA", "LA RIOJA", 
  "LUGO", "MADRID", "MALAGA", "MURCIA", "NAVARRA", "OURENSE", "ASTURIAS", 
  "PALENCIA", "LAS PALMAS", "PONTEVEDRA", "SALAMANCA", "SANTA CRUZ DE TENERIFE", 
  "CANTABRIA", "SEGOVIA", "SEVILLA", "SORIA", "TARRAGONA", "TERUEL", "TOLEDO", 
  "VALENCIA", "VALLADOLID", "VIZCAYA", "ZAMORA", "ZARAGOZA"
].map(p => ({ id: p, label: p }));

// 2. V√çAS (Sincronizadas con VIA_PELIGROSA)
const vias = [
  { id: "AUTOPISTA", label: "Autopista" },
  { id: "AUTOVIA", label: "Autov√≠a" },
  { id: "CARRETERA CONVENCIONAL", label: "Carretera Convencional" },
  { id: "VIA URBANA", label: "V√≠a Urbana" },
  { id: "OTROS TIPOS", label: "Otros Tipos" },
];

// 3. CLIMAS (Sincronizados con CONDICION_PELIGROSA)
const climas = [
  { id: "DESPEJADO", label: "Despejado" },
  { id: "LLUVIA", label: "Lluvia" },
  { id: "NIEBLA", label: "Niebla" },
  { id: "NIEVE", label: "Nieve" },
  { id: "GRANIZO", label: "Granizo" },
  { id: "VIENTO", label: "Viento Fuerte" },
  { id: "OTROS", label: "Otros" },
  { id: "DESCONOCIDO", label: "Desconocido" },
];

// 4. ILUMINACI√ìN (Sincronizada con ILUMINACION_DEFICIENTE)
const iluminacion = [
  { id: "PLENO D√çA", label: "Pleno d√≠a" },
  { id: "CREP√öSCULO", label: "Crep√∫sculo / Alba" },
  { id: "NOCTURNA CON ALUMBRADO", label: "Noche con iluminaci√≥n" },
  { id: "NOCTURNA SIN ALUMBRADO", label: "Noche sin iluminaci√≥n" },
  { id: "DESCONOCIDO", label: "Desconocido" },
];

// 5. TIPOS DE ACCIDENTE
const tiposAccidente = [
  { id: "ALCANCE", label: "Alcance" },
  { id: "CHOQUE FRONTAL", label: "Choque Frontal" },
  { id: "CHOQUE LATERAL", label: "Choque Lateral" },
  { id: "COLISION MULTIPLE", label: "Colisi√≥n M√∫ltiple" },
  { id: "SALIDA DE VIA", label: "Salida de V√≠a" },
  { id: "ATROPELLO", label: "Atropello" },
  { id: "VUELCO", label: "Vuelco" },
  { id: "OTRO", label: "Otro" },
];

// 6. DATOS TEMPORALES (Nuevos: Necesarios para el modelo v2.0)
const meses = [
  { id: "1", label: "Enero" }, { id: "2", label: "Febrero" }, { id: "3", label: "Marzo" },
  { id: "4", label: "Abril" }, { id: "5", label: "Mayo" }, { id: "6", label: "Junio" },
  { id: "7", label: "Julio" }, { id: "8", label: "Agosto" }, { id: "9", label: "Septiembre" },
  { id: "10", label: "Octubre" }, { id: "11", label: "Noviembre" }, { id: "12", label: "Diciembre" }
];

const diasSemana = [
  { id: "LUNES", label: "Lunes" }, { id: "MARTES", label: "Martes" },
  { id: "MIERCOLES", label: "Mi√©rcoles" }, { id: "JUEVES", label: "Jueves" },
  { id: "VIERNES", label: "Viernes" }, { id: "SABADO", label: "S√°bado" },
  { id: "DOMINGO", label: "Domingo" }
];

const horas = Array.from({ length: 24 }, (_, i) => ({ 
  id: i.toString(), 
  label: `${i.toString().padStart(2, '0')}:00h` 
}));

// 7. CARRETERA (C√≥digos DGT)
const carreteras = [
  { id: "0", label: "Casco Urbano / Otros" },
  { id: "1", label: "Red Carreteras del Estado" },
  { id: "6", label: "Autov√≠a / Autopista" }
];
---
<section id="simulador" class="py-20 px-4">
  <div class="max-w-3xl mx-auto relative">
    <div class="absolute -top-10 -right-10 w-32 h-32 bg-forest-500/5 rounded-full border border-forest-500/10 animate-pulse"></div>

    <div class="bg-ocean-950/80 backdrop-blur-3xl border border-white/10 rounded-4xl shadow-2xl overflow-hidden">
      <div class="bg-white/5 p-6 md:p-10 border-b border-white/10">
        <div class="flex items-center gap-4 mb-4">
          <div class="w-3 h-3 rounded-full bg-red-500 shadow-[0_0_10px_rgba(239,68,68,0.5)]"></div>
          <div class="w-3 h-3 rounded-full bg-yellow-500"></div>
          <div class="w-3 h-3 rounded-full bg-green-500"></div>
          <span class="ml-auto text-[10px] font-mono text-white/30 uppercase tracking-[0.3em]">ML Processor Active</span>
        </div>
        <h3 class="text-3xl font-display font-black text-white italic uppercase tracking-tighter">
          Risk<span class="text-forest-500">Calc</span> v2.0
        </h3>
        <p class="text-white/50 text-xs font-mono mt-2">
          Configuraci√≥n de par√°metros ambientales y viales para predicci√≥n de letalidad mediante XGBoost + SMOTE.
        </p>
      </div>

      <form id="form-predict" class="p-6 md:p-10 space-y-8">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-6">
          
          <SimuladorField
            id="PROVINCIA"
            label="Provincia"
            options={provincias.map(p => ({ id: p, label: p }))}
            number="01"
            required={true}
          />

          <SimuladorField
            id="TIPO_VIA_NOMBRE"
            label="Tipo de V√≠a"
            options={vias}
            number="02"
            required={true}
          />

          <SimuladorField
            id="HORA"
            label="Hora del Incidente"
            options={Array.from({length: 24}, (_, i) => ({ id: i.toString(), label: `${i}:00h` }))}
            number="03"
            required={true}
          />

          <SimuladorField
            id="MES"
            label="Mes"
            options={[
              { id: "1", label: "Enero" }, { id: "2", label: "Febrero" }, { id: "3", label: "Marzo" },
              { id: "4", label: "Abril" }, { id: "5", label: "Mayo" }, { id: "6", label: "Junio" },
              { id: "7", label: "Julio" }, { id: "8", label: "Agosto" }, { id: "9", label: "Septiembre" },
              { id: "10", label: "Octubre" }, { id: "11", label: "Noviembre" }, { id: "12", label: "Diciembre" }
            ]}
            number="04"
            required={true}
          />

          <SimuladorField
            id="DIA_SEMANA"
            label="D√≠a de la Semana"
            options={[
              { id: "LUNES", label: "Lunes" }, { id: "MARTES", label: "Martes" },
              { id: "MI√âRCOLES", label: "Mi√©rcoles" }, { id: "JUEVES", label: "Jueves" },
              { id: "VIERNES", label: "Viernes" }, { id: "S√ÅBADO", label: "S√°bado" },
              { id: "DOMINGO", label: "Domingo" }
            ]}
            number="05"
            required={true}
          />

          <SimuladorField
            id="CONDICION_METEO"
            label="Meteorolog√≠a"
            options={climas}
            number="06"
            required={true}
          />

          <SimuladorField
            id="CONDICION_ILUMINACION"
            label="Iluminaci√≥n"
            options={[
              { id: "PLENO D√çA", label: "Pleno D√≠a" },
              { id: "CREP√öSCULO", label: "Crep√∫sculo" },
              { id: "NOCTURNA SIN ALUMBRADO", label: "Noche Sin Alumbrado" },
              { id: "NOCTURNA CON ALUMBRADO", label: "Noche Con Alumbrado" }
            ]}
            number="07"
            required={true}
          />

          <SimuladorField
            id="TIPO_ACCIDENTE_NOMBRE"
            label="Tipo de Accidente"
            options={tiposAccidente}
            number="08"
            required={true}
          />

          <SimuladorField
            id="CARRETERA"
            label="Titularidad de V√≠a"
            options={[
              { id: "0", label: "Urbana / No Especificado" },
              { id: "1", label: "Interurbana / Nacional" },
              { id: "6", label: "Autov√≠a / Autopista" }
            ]}
            number="09"
            required={true}
            fullWidth={true}
          />
        </div>

        <button
          type="submit"
          class="w-full cursor-pointer relative group overflow-hidden bg-forest-500 hover:bg-forest-400 text-white font-black py-5 rounded-2xl transition-all uppercase tracking-[0.3em] text-[10px]"
        >
          <span class="relative z-10">Ejecutar An√°lisis Predictivo</span>
        </button>
      </form>

      <SimuladorResult />
    </div>
  </div>
</section>

<style>
  @keyframes shine {
    100% {
      left: 125%;
    }
  }
  select option {
    background-color: #0a192f;
    color: white;
  }
</style>
<script>
  const form = document.getElementById("form-predict");
  const resContainer = document.getElementById("resultado-container");
  const resCat = document.getElementById("res-categoria");
  const resProb = document.getElementById("res-prob");
  const resBar = document.getElementById("res-bar");

  form?.addEventListener("submit", async (e) => {
    e.preventDefault();
    if (!resContainer || !resCat || !resProb || !resBar) return;

    resContainer.classList.remove("hidden");
    resCat.innerText = "Calculando...";
    resCat.style.color = "#9ca3af"; // Color gris mientras calcula
    resBar.style.width = "0%";

    const formData = new FormData(form);

    // Obtener d√≠a actual correctamente
    const dias = [
      "DOMINGO",
      "LUNES",
      "MARTES",
      "MI√âRCOLES",
      "JUEVES",
      "VIERNES",
      "S√ÅBADO",
    ];
    const diaActual = dias[new Date().getDay()];

    // Datos EXACTAMENTE como espera el modelo
    const data = {
      HORA: new Date().getHours(),
      MES: new Date().getMonth() + 1,
      DIA_SEMANA: diaActual,
      PROVINCIA: formData.get("PROVINCIA"),
      TIPO_VIA_NOMBRE: formData.get("TIPO_VIA_NOMBRE"),
      CONDICION_METEO: formData.get("CONDICION_METEO"),
      CONDICION_ILUMINACION: formData.get("CONDICION_ILUMINACION"),
      TIPO_ACCIDENTE_NOMBRE: formData.get("TIPO_ACCIDENTE_NOMBRE") || "OTRO",
      CARRETERA: formData.get("CARRETERA") || "0",
      // Opcionales que puedes enviar si quieres
      CONDICION_FIRME: formData.get("CONDICION_FIRME") || "SECO",
      TRAZADO_PLANTA: formData.get("TRAZADO_PLANTA") || "RECTA",
    };

    console.log("üì§ Enviando datos:", data);

    try {
      const response = await fetch("http://127.0.0.1:8000/predict", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          Accept: "application/json",
        },
        body: JSON.stringify(data),
      });

      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }

      const result = await response.json();
      console.log("üì• Respuesta recibida:", result);

      // Animaci√≥n suave de la barra
      setTimeout(() => {
        resCat.innerText = result.categoria;
        resCat.style.color = result.color;
        resProb.innerText = `${result.probabilidad}%`;
        resBar.style.backgroundColor = result.color;

        // Animaci√≥n progresiva de la barra
        let width = 0;
        const interval = setInterval(() => {
          if (width >= result.probabilidad) {
            clearInterval(interval);
          } else {
            width += 1;
            resBar.style.width = `${width}%`;
          }
        }, 10);
      }, 300);
    } catch (error) {
      console.error("‚ùå Error:", error);
      resCat.innerText = "Error";
      resCat.style.color = "#ef4444";
      resProb.innerText = "0%";
      resBar.style.width = "0%";
      resBar.style.backgroundColor = "#ef4444";

      setTimeout(() => {
        alert(
          "Error: No se pudo conectar con el servidor AI.\nAseg√∫rate de que la API est√° corriendo en http://127.0.0.1:8000"
        );
      }, 500);
    }
  });

  // Funci√≥n opcional para obtener categor√≠as v√°lidas de la API
  async function cargarCategorias() {
    try {
      const response = await fetch("http://127.0.0.1:8000/categorias");
      const categorias = await response.json();
      console.log("Categor√≠as disponibles:", categorias);
      // Aqu√≠ podr√≠as actualizar din√°micamente los selects si quisieras
    } catch (error) {
      console.log(
        "No se pudieron cargar categor√≠as, usando valores por defecto"
      );
    }
  }

  // Llamar al cargar la p√°gina (opcional)
  // cargarCategorias();
</script>
