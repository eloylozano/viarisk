---
import SimuladorField from "./SimuladorField.astro";
import SimuladorResult from "./SimuladorResult.astro";
import { MAPPINGS } from "../data/mappings.js"; // Asegúrate de que la ruta sea correcta
import HolographicButton from "./HolographicButton.astro";

// Transformamos los objetos de mappings.js en arrays para los selectores
const provincias = Object.entries(MAPPINGS.PROVINCIA).map(([id, label]) => ({
  id,
  label,
}));
const vias = Object.entries(MAPPINGS.TIPO_VIA_NOMBRE).map(([id, label]) => ({
  id,
  label,
}));
const climas = Object.entries(MAPPINGS.CONDICION_METEO).map(([id, label]) => ({
  id,
  label,
}));
const luces = Object.entries(MAPPINGS.CONDICION_ILUMINACION).map(
  ([id, label]) => ({ id, label })
);
const zonas = Object.entries(MAPPINGS.ZONA_AGRUPADA).map(([id, label]) => ({
  id,
  label,
}));
const horas = Array.from({ length: 24 }, (_, i) => ({
  id: i,
  label: `${i.toString().padStart(2, "0")}:00`,
}));

const meses = Object.entries(MAPPINGS.MES).map(([id, label]) => ({
  id,
  label,
}));
---

<section id="simulador" class="py-24 px-4">
  <div class="max-w-7xl mx-auto">
    <div
      class="flex flex-col lg:flex-row bg-ocean-950/40 backdrop-blur-3xl border border-white/10 rounded-[3rem] shadow-2xl overflow-hidden relative"
    >
      <div
        class="hidden lg:flex absolute left-[33.33%] top-0 bottom-0 -translate-x-1/2 w-8 z-20 flex-col items-center justify-between py-12 pointer-events-none"
      >
        <div class="w-2 h-2 rounded-full bg-white/20 border border-white/10">
        </div>
        <div
          class="w-px h-full bg-linear-to-b from-transparent via-white/10 to-transparent"
        >
        </div>
        <div
          class="w-4 h-8 border-x border-white/10 flex flex-col justify-around items-center"
        >
          <div class="w-full h-px bg-white/10"></div>
          <div class="w-full h-px bg-white/10"></div>
        </div>
        <div
          class="w-px h-full bg-linear-to-t from-transparent via-white/10 to-transparent"
        >
        </div>
        <div class="w-2 h-2 rounded-full bg-white/20 border border-white/10">
        </div>
      </div>

      <div
        class="flex-1 p-10 md:p-14 bg-white/2 border-b lg:border-b-0 lg:border-r border-white/10 relative overflow-hidden group"
      >
        <div
          class="absolute top-0 left-0 w-full h-full bg-[radial-linear(circle_at_0%_0%,rgba(16,185,129,0.05)_0%,transparent_50%)]"
        >
        </div>

        <div class="relative z-10 space-y-10">
          <div class="space-y-4">
            <div class="flex items-center gap-3">
              <span
                class="px-2 py-1 bg-forest-500/10 border border-forest-500/20 text-forest-500 text-[9px] font-mono uppercase tracking-widest rounded"
              >
                Engine Status: Operational
              </span>
              <div class="h-px flex-1 bg-white/5"></div>
            </div>
            <h3
              class="text-4xl font-display font-black text-white leading-tight uppercase italic"
            >
              Data <span class="text-forest-500">Core</span>
            </h3>
            <div class="space-y-3">
              <p class="text-white/70 text-base leading-relaxed font-light">
                Este núcleo procesa una red neuronal entrenada con <span
                  class="text-white font-semibold"
                  >+500,000 registros históricos</span
                > de la DGT para identificar patrones de letalidad.
              </p>
              <p class="text-white/40 text-sm leading-relaxed">
                El algoritmo analiza la correlación entre la infraestructura, la
                visibilidad y el factor temporal para calcular la probabilidad
                de un desenlace crítico.
              </p>
            </div>
          </div>

          <div class="space-y-8">
            <div class="group/item transition-all">
              <div class="flex justify-between items-end mb-2">
                <div class="flex flex-col">
                  <span
                    class="text-[10px] font-mono text-forest-500 uppercase tracking-tighter"
                    >Dominancia de Entorno</span
                  >
                  <span class="text-[11px] text-white/30 italic"
                    >Impacto del tipo de vía en la decisión</span
                  >
                </div>
                <span class="text-sm font-mono text-white font-bold">47.8%</span
                >
              </div>
              <div class="h-1.5 w-full bg-white/5 rounded-full overflow-hidden">
                <div
                  class="h-full bg-forest-500 w-[47.8%] shadow-[0_0_15px_rgba(16,185,129,0.4)]"
                >
                </div>
              </div>
            </div>

            <div class="group/item transition-all">
              <div class="flex justify-between items-end mb-2">
                <div class="flex flex-col">
                  <span
                    class="text-[10px] font-mono text-red-400 uppercase tracking-tighter"
                    >Tasa de Sensibilidad (Recall)</span
                  >
                  <span class="text-[11px] text-white/30 italic"
                    >Capacidad de detección de casos fatales</span
                  >
                </div>
                <span class="text-sm font-mono text-white font-bold">66.0%</span
                >
              </div>
              <div class="h-1.5 w-full bg-white/5 rounded-full overflow-hidden">
                <div
                  class="h-full bg-red-500 w-[66%] shadow-[0_0_15px_rgba(239,68,68,0.4)]"
                >
                </div>
              </div>
            </div>
          </div>

          <details
            class="group/note bg-black/40 border border-white/5 rounded-2xl relative overflow-hidden transition-all duration-300"
          >
            <summary
              class="list-none cursor-pointer p-5 flex items-center justify-between group-hover:bg-white/2"
            >
              <div
                class="absolute -top-2 -left-2 w-4 h-4 border-t border-l border-forest-500/50"
              >
              </div>

              <div class="flex items-center gap-3">
                <span
                  class="text-forest-500 font-bold text-[12px] tracking-widest uppercase"
                  >Lógica Preventiva</span
                >
                <span
                  class="text-[10px] text-white/20 font-mono hidden md:inline-block"
                  >/ / Click para expandir</span
                >
              </div>

              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="w-4 h-4 text-forest-500 transition-transform duration-300 group-open/note:rotate-180"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M19 9l-7 7-7-7"></path>
              </svg>
            </summary>

            <div class="px-5 pb-5 animate-fadeIn">
              <div class="h-px w-full bg-white/5 mb-4"></div>
              <p class="text-[12px] text-white/50 leading-relaxed italic">
                A diferencia de modelos estándar, este sistema está penalizado
                estadísticamente para evitar
                <span class="text-white/80 font-medium">"falsos negativos"</span
                >. Es decir, ante la duda razonable, el modelo elevará el nivel
                de riesgo para priorizar la seguridad del usuario frente a una
                falsa sensación de confianza.
              </p>
            </div>
          </details>
        </div>
      </div>

      <div
        class="flex-2 p-10 md:p-16 relative bg-linear-to-br from-transparent to-ocean-900/20"
      >
        <div class="flex items-center justify-between mb-10">
          <div>
            <h3
              class="text-2xl font-black text-white tracking-tight uppercase italic"
            >
              Entrada de Parámetros
            </h3>
            <p
              class="text-white/30 text-[10px] uppercase tracking-[0.2em] mt-1"
            >
              Configure las variables del escenario actual
            </p>
          </div>
          <div
            class="flex items-center gap-3 bg-black/20 px-4 py-2 rounded-full border border-white/5"
          >
            <div
              class="w-2 h-2 rounded-full bg-forest-500 animate-pulse shadow-[0_0_8px_#10b981]"
            >
            </div>
            <span
              class="text-[10px] font-mono text-white/50 uppercase tracking-widest"
              >Ready</span
            >
          </div>
        </div>

        <form id="form-predict" class="space-y-10">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-x-10 gap-y-8">
            <SimuladorField
              id="PROVINCIA"
              label="Localización"
              options={provincias}
              number="01"
            />
            <SimuladorField
              id="HORA"
              label="Franja Horaria"
              options={horas}
              number="02"
            />
            <SimuladorField
              id="MES"
              label="Mes del Año"
              options={meses}
              number="03"
            />
            <SimuladorField
              id="TIPO_VIA_NOMBRE"
              label="Tipo de Vía"
              options={vias}
              number="04"
            />
            <SimuladorField
              id="CONDICION_METEO"
              label="Estado Climático"
              options={climas}
              number="05"
            />
            <SimuladorField
              id="CONDICION_ILUMINACION"
              label="Visibilidad"
              options={luces}
              number="06"
            />

            <div class="hidden">
              <SimuladorField
                id="ZONA_AGRUPADA"
                label="Entorno"
                options={zonas}
                number="--"
              />
            </div>
          </div>

          <HolographicButton />

          <SimuladorResult />
        </form>
      </div>
    </div>
  </div>
</section>

<style>
  /* Animación suave para el contenido */
  .animate-fadeIn {
    animation: fadeIn 0.4s ease-out forwards;
  }

  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: translateY(-5px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  /* Ocultar la flecha por defecto de Chrome/Safari */
  details summary::-webkit-details-marker {
    display: none;
  }
</style>

<script>
  // Usamos aserciones de tipo para que TS no se queje
  const form = document.getElementById("form-predict") as HTMLFormElement;
  const resContainer = document.getElementById(
    "resultado-container"
  ) as HTMLElement;
  const resCat = document.getElementById("res-categoria") as HTMLElement;
  const resProb = document.getElementById("res-prob") as HTMLElement;
  const resBar = document.getElementById("res-bar") as HTMLElement;

  const selectVia = document.getElementById(
    "TIPO_VIA_NOMBRE"
  ) as HTMLSelectElement;
  const selectZona = document.getElementById(
    "ZONA_AGRUPADA"
  ) as HTMLSelectElement;
  const selectHora = document.getElementById("HORA") as HTMLSelectElement;
  const selectLuz = document.getElementById(
    "CONDICION_ILUMINACION"
  ) as HTMLSelectElement;

  // --- LOGICA DE AUTOMATIZACIÓN ---
  const viaToZona: Record<string, string> = {
    "1": "1",
    "2": "1",
    "3": "1",
    "4": "1",
    "5": "1",
    "6": "1",
    "7": "1",
    "8": "1",
    "10": "1",
    "14": "1",
    "9": "2",
    "11": "2",
    "12": "2",
    "13": "2",
  };

  selectVia?.addEventListener("change", () => {
    const zonaSugerida = viaToZona[selectVia.value];
    if (zonaSugerida && selectZona) {
      selectZona.value = zonaSugerida;
    }
  });

  selectHora?.addEventListener("change", () => {
    const hora = parseInt(selectHora.value);
    if (selectLuz) {
      if (hora >= 8 && hora <= 18) selectLuz.value = "1";
      else if (hora >= 19 && hora <= 21) selectLuz.value = "3";
      else selectLuz.value = "4";
    }
  });

  // --- GESTIÓN DEL ENVÍO ---
  form?.addEventListener("submit", async (e) => {
    e.preventDefault();

    // Verificación de seguridad
    if (!resContainer || !resCat || !resProb || !resBar) return;

    // Reset de UI
    resContainer.classList.remove("hidden");
    resCat.innerText = "Procesando...";
    resBar.style.width = "10%";

    const formData = new FormData(form);
    const dayMap = ["7", "1", "2", "3", "4", "5", "6"];
    const diaActual = dayMap[new Date().getDay()];

    const data = {
      HORA: parseInt(formData.get("HORA") as string),
      MES: parseInt(formData.get("MES") as string),
      DIA_SEMANA: diaActual,
      PROVINCIA: String(formData.get("PROVINCIA")),
      TIPO_VIA_NOMBRE: String(formData.get("TIPO_VIA_NOMBRE")),
      CONDICION_METEO: String(formData.get("CONDICION_METEO")),
      CONDICION_ILUMINACION: String(formData.get("CONDICION_ILUMINACION")),
      ZONA_AGRUPADA: String(formData.get("ZONA_AGRUPADA")),
    };

    try {
      // Usamos la URL de entorno o fallback manual si falla
      const apiUrl =
        import.meta.env.PUBLIC_API_URL;

      const response = await fetch(`${apiUrl}/predict`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(data),
      });

      if (!response.ok) throw new Error("API Offline");

      const result = await response.json();

      // Animación de carga
      setTimeout(() => {
        resCat.innerText = result.categoria || "Completado";
        resCat.style.color = result.color || "#ffffff";
        resProb.innerText = `${result.probabilidad}%`;
        resBar.style.backgroundColor = result.color || "#3b82f6";
        resBar.style.width = `${result.probabilidad}%`;
      }, 500);
    } catch (error) {
      console.error("API Error:", error);
      resCat.innerText = "Error de Conexión";
      resCat.style.color = "#ef4444";
      resProb.innerText = "---";
      resBar.style.width = "0%";
    }
  });
</script>
