---
import { MAPPINGS } from "../data/mappings.js";
import probHoraAnual from "../data/prob_mortalidad_hora_anual.json";
import statsTipologiaAnual from "../data/stats_tipologia_anual.json";
import statsMeteoAnual from "../data/stats_meteo_anual.json";
import statsProvinciasAnual from "../data/stats_provincias_anual.json";

const rawData = {
  hora: probHoraAnual,
  tipo: statsTipologiaAnual,
  meteo: statsMeteoAnual,
  prov: statsProvinciasAnual,
};
---

<div
  class="lg:col-span-3 space-y-6"
  id="insights-container"
  data-raw={JSON.stringify(rawData)}
>
  <div class="flex items-center justify-between border-b border-white/10 pb-4">
    <h3 class="text-white font-black text-xs uppercase tracking-[0.2em]">
      IA Insights
    </h3>
    <span class="text-[9px] text-forest-500 font-mono animate-pulse"
      >SISTEMA_ACTIVO</span
    >
  </div>

  <div
    class="group bg-white/2 border border-white/5 p-5 rounded-3xl space-y-3"
  >
    <div class="flex justify-between items-end">
      <span class="text-white/30 text-[9px] font-black uppercase"
        >Franja Crítica</span
      >
      <span class="text-white font-mono text-xs" id="ins-hora-val">--:--H</span>
    </div>
    <div class="h-1.5 w-full bg-white/5 rounded-full overflow-hidden">
      <div
        id="ins-hora-bar"
        class="h-full bg-forest-500 transition-all duration-1000"
        style="width: 0%"
      >
      </div>
    </div>
  </div>

  <div class="bg-purple-500/5 border border-purple-500/20 p-6 rounded-4xl">
    <span class="text-purple-400/50 text-[9px] font-black uppercase block mb-1"
      >Letalidad Máxima</span
    >
    <h4
      class="text-white text-sm font-bold uppercase mb-2"
      id="ins-tipo-nombre"
    >
      Cargando...
    </h4>
    <div
      class="text-[10px] text-purple-400 font-mono bg-purple-400/10 w-fit px-2 py-1 rounded"
    >
      RIESGO +<span id="ins-tipo-val">0</span>%
    </div>
  </div>

  <div class="bg-red-500/5 border border-red-500/20 p-6 rounded-4xl">
    <div class="flex justify-between items-start mb-1">
      <span class="text-red-400/50 text-[9px] font-black uppercase"
        >Punto Caliente Geo</span
      >
      <span class="text-red-500 font-mono text-xs font-bold"
        ><span id="ins-prov-val">0</span>%</span
      >
    </div>
    <h4
      class="text-white text-sm font-bold uppercase mb-3"
      id="ins-prov-nombre"
    >
      Cargando...
    </h4>
    <div class="w-full bg-white/5 h-1.5 rounded-full overflow-hidden">
      <div
        id="ins-prov-bar"
        class="bg-red-500 h-full transition-all duration-1000"
        style="width: 0%"
      >
      </div>
    </div>
  </div>

  <div class="bg-sky-600 p-6 rounded-[2.5rem] relative overflow-hidden">
    <span class="text-sky-100/60 text-[9px] font-black uppercase block mb-1"
      >Factor Externo</span
    >
    <h4
      class="text-white text-sm font-bold uppercase mb-3"
      id="ins-meteo-nombre"
    >
      Cargando...
    </h4>
    <p class="text-sky-100/80 text-[10px] leading-relaxed">
      Precaución: El riesgo aumenta bajo condiciones de <span
        class="text-white font-bold"
        id="ins-meteo-desc">...</span
      >.
    </p>
  </div>
</div>

<script>
  import { MAPPINGS } from "../data/mappings.js";

  // Definimos una interfaz básica para los datos que vienen del JSON
  // Esto quita los errores de "any" al acceder a .HORA, .ANIO, etc.
  interface AccidenteRecord {
    ANIO?: string | number;
    HORA?: number;
    Probabilidad_Mortal?: number;
    Mortalidad_Media?: number;
    Riesgo_Medio?: number;
    ES_MORTAL?: number;
    TIPO_ACCIDENTE_NOMBRE?: string | number;
    PROVINCIA?: string | number;
    CONDICION_METEO?: string | number;
  }

  function initInsights() {
    const container = document.getElementById(
      "insights-container"
    ) as HTMLElement;
    if (!container) return;

    let raw: { [key: string]: AccidenteRecord[] };
    try {
      raw = JSON.parse(container.dataset.raw || "{}");
    } catch (e) {
      return;
    }

    const updateInsights = (year: string) => {
      const filter = (arr: AccidenteRecord[] | undefined) => {
        if (!arr || !Array.isArray(arr)) return [];
        return year === "all"
          ? arr
          : arr.filter((d) => String(d.ANIO) === String(year));
      };

      const setUI = (id: string, val: string | number) => {
        const el = document.getElementById(id);
        if (el) el.textContent = String(val);
      };

      const setW = (id: string, p: number) => {
        const el = document.getElementById(id);
        if (el) (el as HTMLElement).style.width = Math.min(p, 100) + "%";
      };

      // 1. HORA
      const hData = filter(raw.hora);
      if (hData.length) {
        const top = hData.reduce((p, c) =>
          Number(p.Probabilidad_Mortal || 0) >
          Number(c.Probabilidad_Mortal || 0)
            ? p
            : c
        );
        setUI("ins-hora-val", `${top.HORA}:00H`);
        setW("ins-hora-bar", Number(top.Probabilidad_Mortal || 0) * 100);
      }

      // 2. TIPOLOGÍA
      const tData = filter(raw.tipo);
      if (tData.length) {
        const top = tData.reduce((p, c) =>
          Number(p.Mortalidad_Media || 0) > Number(c.Mortalidad_Media || 0)
            ? p
            : c
        );
        const idKey = String(top.TIPO_ACCIDENTE_NOMBRE || "");
        // @ts-ignore - Ignoramos si TypeScript no conoce todas las llaves de MAPPINGS
        const nombre =
          MAPPINGS?.TIPO_ACCIDENTE_NOMBRE?.[idKey] || `Tipo ${idKey}`;
        setUI("ins-tipo-nombre", nombre);
        setUI(
          "ins-tipo-val",
          (Number(top.Mortalidad_Media || 0) * 100).toFixed(0)
        );
      }

      // 3. PROVINCIA
      const pData = filter(raw.prov);
      if (pData.length) {
        const top = pData.reduce((p, c) =>
          Number(p.Riesgo_Medio || 0) > Number(c.Riesgo_Medio || 0) ? p : c
        );
        const idKey = String(top.PROVINCIA || "");
        // @ts-ignore
        const nombre = MAPPINGS?.PROVINCIA?.[idKey] || `Prov. ${idKey}`;
        setUI("ins-prov-nombre", nombre);
        setUI("ins-prov-val", (Number(top.Riesgo_Medio || 0) * 100).toFixed(1));
        setW("ins-prov-bar", Number(top.Riesgo_Medio || 0) * 100);
      }

      // 4. METEO
      const mData = filter(raw.meteo);
      if (mData.length) {
        const top = mData.reduce((p, c) =>
          Number(p.ES_MORTAL || 0) > Number(c.ES_MORTAL || 0) ? p : c
        );
        const idKey = String(top.CONDICION_METEO || "");
        // @ts-ignore
        const nom = MAPPINGS?.CONDICION_METEO?.[idKey] || "Despejado";
        setUI("ins-meteo-nombre", nom);
        setUI(
          "ins-meteo-desc",
          typeof nom === "string" ? nom.toLowerCase() : "condiciones adversas"
        );
      }
    };

    // Escuchador de eventos con tipado para el CustomEvent
    window.addEventListener("filterCharts", ((e: CustomEvent) => {
      updateInsights(e.detail.year);
    }) as EventListener);

    updateInsights("all");
  }

  initInsights();
  document.addEventListener("astro:after-swap", initInsights);
</script>
