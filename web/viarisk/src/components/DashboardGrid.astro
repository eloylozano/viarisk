---
import ChartCard from "./ChartCard.astro";

// --- IMPORTACIÓN DE DATOS ---
import statsKpis from "../data/stats_global_kpis.json";
import probHoraAnual from "../data/prob_mortalidad_hora_anual.json";
import statsTipologiaAnual from "../data/stats_tipologia_anual.json";
import statsMotosAnual from "../data/stats_motoristas_interaccion_anual.json";
import statsIluminacionAnual from "../data/stats_iluminacion_anual.json";
import statsFirmeAnual from "../data/stats_firme_anual.json";
import statsProvinciasAnual from "../data/stats_provincias_anual.json";

const años = [2020, 2021, 2022, 2023, 2024];

// Definición de interfaces para evitar errores de tipado en el script
interface StatRecord {
  ANIO: number;
  total_muertos_moto: number;
  total_muertos_coche: number;
  total_accidentes: number;
}
---

<script is:inline define:vars={{ statsKpis }}>
  // Inyectamos los datos en el objeto window para acceso rápido del cliente
  window.STATS_DATA = statsKpis;
</script>

<div
  class="flex flex-col gap-6 md:gap-8 w-full pb-20 px-4 md:px-0"
  id="dashboard"
>
  <div
    class="flex flex-wrap items-center justify-center lg:justify-start gap-2 md:gap-3 bg-white/5 p-2 rounded-2xl border border-white/5 w-full lg:w-fit self-center lg:self-start"
  >
    <button
      data-year-btn="all"
      class="flex-1 lg:flex-none cursor-pointer px-4 py-2 rounded-xl text-[10px] font-black uppercase tracking-widest transition-all bg-forest-500 text-white shadow-lg shadow-forest-500/20"
    >
      Global
    </button>
    {
      años.map((año) => (
        <button
          data-year-btn={año.toString()}
          class="flex-1 lg:flex-none cursor-pointer px-4 py-2 rounded-xl text-[10px] font-black uppercase tracking-widest transition-all bg-transparent text-white/40 hover:text-white hover:bg-white/5"
        >
          {año}
        </button>
      ))
    }
  </div>

  <section class="flex flex-col gap-6">
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <div
        class="lg:col-span-3 min-h-[350px] md:h-[320px] relative overflow-hidden bg-black/40 border border-white/5 rounded-3xl p-4 md:p-8 shadow-lg"
      >
        <div
          id="wrapper-evol"
          class="h-full w-full transition-all duration-500 opacity-100 scale-100 block"
        >
          <ChartCard
            id="chart-evol"
            title="Evolución Fallecidos (Moto)"
            data={statsKpis}
            xKey="ANIO"
            yKey="total_accidentes"
            type="line"
            color="#10b981"
          />
        </div>

        <div
          id="wrapper-kpis"
          class="absolute inset-0 flex flex-col md:flex-row items-center justify-center md:justify-around gap-8 md:gap-0 p-6 md:p-8 transition-all duration-500 opacity-0 translate-y-10 pointer-events-none hidden"
        >
          <div class="text-center">
            <span
              class="text-forest-500 text-[10px] md:text-xs font-black uppercase tracking-[0.2em] block mb-2"
              >Siniestros Totales</span
            >
            <div
              class="text-6xl md:text-8xl font-black text-white tracking-tighter tabular-nums leading-none"
              id="kpi-total-accidentes"
            >
              0
            </div>
            <div
              id="kpi-anio-label"
              class="text-white/20 text-[10px] mt-3 font-mono uppercase tracking-widest font-bold"
            >
              GLOBAL
            </div>
          </div>

          <div class="h-px w-20 md:h-24 md:w-px bg-white/10 hidden md:block">
          </div>

          <div class="text-center">
            <span
              class="text-red-500 text-[10px] md:text-xs font-black uppercase tracking-[0.2em] block mb-2"
              >Índice de Letalidad</span
            >
            <div
              class="text-6xl md:text-8xl font-black text-white tracking-tighter tabular-nums leading-none"
              id="kpi-letalidad"
            >
              0.00%
            </div>
            <div
              id="kpi-fallecidos-sub"
              class="text-red-500/40 text-[10px] mt-3 font-mono uppercase tracking-widest italic font-bold"
            >
              ---
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <section class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-6">
    <div class="md:col-span-2 lg:col-span-1">
      <ChartCard
        id="chart-motos"
        title="Interacción"
        data={statsMotosAnual}
        xKey="TIPO_INTERACCION"
        yKey="TOTAL"
        type="doughnut"
        color="#f59e0b"
      />
    </div>
    <div class="lg:col-span-2">
      <ChartCard
        id="chart-ilumin"
        title="Riesgo Iluminación"
        data={statsIluminacionAnual}
        xKey="CONDICION_ILUMINACION"
        yKey="ES_MORTAL"
        type="bar"
        color="#fbbf24"
      />
    </div>
    <div class="lg:col-span-2">
      <ChartCard
        id="chart-firme"
        title="Riesgo Estado Firme"
        data={statsFirmeAnual}
        xKey="CONDICION_FIRME"
        yKey="ES_MORTAL"
        type="bar"
        color="#6366f1"
      />
    </div>
    <div class="col-span-1 md:col-span-2 lg:col-span-5">
      <ChartCard
        id="chart-prov"
        title="Fallecidos por Provincias"
        data={statsProvinciasAnual}
        xKey="PROVINCIA"
        yKey="Fallecidos"
        type="bar"
        color="#ef4444"
      />
    </div>
  </section>
</div>

<script>
  // Tipado para la variable global
  interface StatRecord {
    ANIO: number;
    total_muertos_moto: number;
    total_muertos_coche: number;
    total_accidentes: number;
  }

  declare global {
    interface Window {
      STATS_DATA: StatRecord[];
    }
  }

  const buttons = document.querySelectorAll("[data-year-btn]");
  const wrapperEvol = document.getElementById("wrapper-evol");
  const wrapperKpis = document.getElementById("wrapper-kpis");

  function animateValue(
    id: string,
    target: number,
    isPercent: boolean = false
  ) {
    const el = document.getElementById(id);
    if (!el) return;

    let start = 0;
    const duration = 800;
    const startTime = performance.now();

    function update(now: number) {
      const elapsed = now - startTime;
      const progress = Math.min(elapsed / duration, 1);
      const easeProgress = 1 - Math.pow(1 - progress, 3);
      const value = start + (target - start) * easeProgress;

      el!.textContent = isPercent
        ? value.toFixed(2) + "%"
        : Math.floor(value).toLocaleString();

      if (progress < 1) requestAnimationFrame(update);
    }
    requestAnimationFrame(update);
  }

  buttons.forEach((btn) => {
    btn.addEventListener("click", () => {
      const year = btn.getAttribute("data-year-btn");
      if (!year || !wrapperEvol || !wrapperKpis) return;

      // Estilos de botones
      buttons.forEach((b) => {
        b.classList.remove("bg-forest-500", "text-white", "shadow-lg");
        b.classList.add("bg-transparent", "text-white/40");
      });
      btn.classList.add("bg-forest-500", "text-white", "shadow-lg");
      btn.classList.remove("bg-transparent", "text-white/40");

      if (year === "all") {
        // Transición a Gráfica
        wrapperKpis.classList.add("opacity-0", "translate-y-10");
        setTimeout(() => {
          wrapperKpis.classList.add("hidden");
          wrapperEvol.classList.remove("hidden");
          setTimeout(
            () => wrapperEvol.classList.remove("opacity-0", "scale-95"),
            20
          );
        }, 300);
      } else {
        // Transición a KPIs
        wrapperEvol.classList.add("opacity-0", "scale-95");
        setTimeout(() => {
          wrapperEvol.classList.add("hidden");
          wrapperKpis.classList.remove("hidden");

          setTimeout(() => {
            wrapperKpis.classList.remove(
              "opacity-0",
              "translate-y-10",
              "pointer-events-none"
            );

            const yearData = window.STATS_DATA.find(
              (d) => String(d.ANIO) === year
            );
            if (yearData) {
              const totalMuertos =
                (yearData.total_muertos_moto || 0) +
                (yearData.total_muertos_coche || 0);
              const letalidad =
                (totalMuertos / yearData.total_accidentes) * 100;

              animateValue("kpi-total-accidentes", yearData.total_accidentes);
              animateValue("kpi-letalidad", letalidad, true);

              const labelAnio = document.getElementById("kpi-anio-label");
              const labelSub = document.getElementById("kpi-fallecidos-sub");
              if (labelAnio) labelAnio.textContent = `DGT DATA ${year}`;
              if (labelSub)
                labelSub.textContent = `${totalMuertos.toLocaleString()} TOTAL DEATHS`;
            }
          }, 20);
        }, 300);
      }

      window.dispatchEvent(
        new CustomEvent("filterCharts", { detail: { year } })
      );
    });
  });
</script>
